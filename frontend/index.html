<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/api@10.9.1/bundle-polkadot-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/extension-dapp@0.46.5/bundle-polkadot-extension-dapp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 8px; }
        button { padding: 10px 15px; background: #5F30E2; color: white; border: none; cursor: pointer; }
        .proposal { background: #f9f9f9; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .debug { background: #f0f0f0; padding: 10px; border-left: 4px solid #ccc; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Polkadot Governance Proposal Tracker</h1>
    
    <div id="connect-section">
        <p><strong>Status:</strong> <span id="connection-status">Not connected</span></p>
        <p><strong>Contract Address:</strong> <span id="contract-address">Loading...</span></p>
        <button id="connectWallet">Connect Wallet</button>
        <div id="debug-info" class="debug">
            <h3>Debug Info:</h3>
            <p>Click buttons to see diagnostic information here.</p>
        </div>
        <div id="accountInfo" style="display:none;">
            <p>Connected: <span id="accountAddress"></span></p>
        </div>
    </div>

    <hr>

    <div id="app" style="display:none;">
        <h2>Create New Proposal</h2>
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" id="title" placeholder="Proposal title">
        </div>
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" rows="4" placeholder="Describe your proposal"></textarea>
        </div>
        <button id="submitProposal">Submit Proposal</button>

        <h2>Proposals</h2>
        <button id="loadProposals">Load Proposals</button>
        <div id="proposalsList"></div>
    </div>

    <script>
        // Contract address will be set explicitly for testing
        const CONTRACT_ADDRESS = "5C4hrfjw9DjXZTzV3MwzrrAr9P1MJhSrvWGWqi1eSuyUpnhM"; // Will be updated from config
        
        // Debug logging function
        function debugLog(message, data) {
            const debugInfo = document.getElementById('debug-info');
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '10px';
            logEntry.innerHTML = `<strong>${message}</strong>: ${data ? JSON.stringify(data, null, 2) : ''}`;
            debugInfo.appendChild(logEntry);
            console.log(message, data);
        }
        
        // Display contract address
        document.getElementById('contract-address').textContent = CONTRACT_ADDRESS;
        
        // Variables
        let api;
        let contract;
        let currentAccount;
        let contractMetadata;

        // Connect to blockchain and contract
        async function connect() {
            try {
                debugLog("Starting connection process");
                document.getElementById('connection-status').textContent = "Connecting...";
                
                // Connect to chain
                const { ApiPromise, WsProvider } = polkadotApi;
                const provider = new WsProvider('ws://localhost:9944');
                debugLog("Connecting to node", 'ws://localhost:9944');
                
                try {
                    api = await ApiPromise.create({ provider });
                    debugLog("API Connection successful", {
                        chainName: await api.rpc.system.chain(),
                        version: await api.rpc.system.version()
                    });
                } catch (err) {
                    debugLog("API Connection failed", err.message);
                    document.getElementById('connection-status').textContent = "Node connection failed";
                    return;
                }
                
                // Connect to extension
                try {
                    debugLog("Connecting to Polkadot extension");
                    const { web3Accounts, web3Enable } = polkadotExtensionDapp;
                    const extensions = await web3Enable('Governance Tracker');
                    debugLog("Extensions detected", extensions.length);
                    
                    if (extensions.length === 0) {
                        debugLog("No extensions found", "Please install Polkadot{.js} extension");
                        document.getElementById('connection-status').textContent = "No Polkadot extension detected";
                        return;
                    }
                    
                    const accounts = await web3Accounts();
                    debugLog("Accounts found", accounts.length);
                    
                    if (accounts.length === 0) {
                        debugLog("No accounts found", "Please create an account in Polkadot{.js} extension");
                        document.getElementById('connection-status').textContent = "No accounts in extension";
                        return;
                    }
                    
                    currentAccount = accounts[0];
                    document.getElementById('accountAddress').textContent = currentAccount.address;
                    document.getElementById('accountInfo').style.display = 'block';
                    document.getElementById('connection-status').textContent = "Connected";
                    document.getElementById('app').style.display = 'block';
                } catch (err) {
                    debugLog("Extension connection failed", err.message);
                    document.getElementById('connection-status').textContent = "Extension connection failed";
                    return;
                }
                
                // Fetch contract metadata
                try {
                    debugLog("Fetching contract metadata");
                    const response = await fetch('/target/ink/governance_tracker.json');
                    contractMetadata = await response.json();
                    debugLog("Metadata loaded", { 
                        spec_name: contractMetadata.spec.name,
                        constructors: contractMetadata.spec.constructors.length
                    });
                    
                    // Create contract instance
                    const { ContractPromise } = polkadotApi.contractPromise;
                    contract = new ContractPromise(api, contractMetadata, CONTRACT_ADDRESS);
                    debugLog("Contract instance created");
                } catch (err) {
                    debugLog("Metadata loading failed", err.message);
                    document.getElementById('connection-status').textContent = "Contract metadata loading failed";
                    return;
                }
            } catch (err) {
                debugLog("Connection process failed", err.message);
                document.getElementById('connection-status').textContent = "Connection failed";
            }
        }

        // Submit a new proposal
        async function submitProposal() {
            // ... rest of the code remains the same
        }

        // Load and display proposals
        async function loadProposals() {
            // ... rest of the code remains the same
        }

        // Vote on a proposal
        async function voteOnProposal(id) {
            // ... rest of the code remains the same
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connect);
        document.getElementById('submitProposal').addEventListener('click', submitProposal);
        document.getElementById('loadProposals').addEventListener('click', loadProposals);

        // Try to load contract address from config file
        fetch('/config/contract-address.js')
            .then(response => {
                if (!response.ok) {
                    throw new Error("Config file not found");
                }
                return response.text();
            })
            .then(text => {
                const addressMatch = text.match(/CONTRACT_ADDRESS = "([^"]+)"/);
                if (addressMatch && addressMatch[1]) {
                    const address = addressMatch[1];
                    CONTRACT_ADDRESS = address;
                    document.getElementById('contract-address').textContent = address;
                    debugLog("Loaded contract address from config", address);
                }
            })
            .catch(err => {
                debugLog("Could not load contract address config", err.message);
            });
    </script>
</body>
</html>