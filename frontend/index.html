<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governance Tracker</title>
    <!-- Import Polkadot libraries sequentially with proper variable names -->
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/util@12.3.1/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/util-crypto@12.3.1/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/keyring@12.3.1/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/api@10.9.1/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/extension-dapp@0.46.5/bundle.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 8px; }
        button { padding: 10px 15px; background: #5F30E2; color: white; border: none; cursor: pointer; }
        .proposal { background: #f9f9f9; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .debug { background: #f0f0f0; padding: 10px; border-left: 4px solid #ccc; font-family: monospace; margin: 10px 0; overflow-wrap: break-word; word-break: break-all; }
    </style>
</head>
<body>
    <h1>Polkadot Governance Proposal Tracker</h1>
    
    <div id="connect-section">
        <p><strong>Status:</strong> <span id="connection-status">Not connected</span></p>
        <p><strong>Contract Address:</strong> <span id="contract-address">Loading...</span></p>
        <button id="connectWallet">Connect Wallet</button>
        <div id="debug-info" class="debug">
            <h3>Debug Info:</h3>
            <p>Click buttons to see diagnostic information here.</p>
        </div>
        <div id="accountInfo" style="display:none;">
            <p>Connected: <span id="accountAddress"></span></p>
        </div>
    </div>

    <hr>

    <div id="app" style="display:none;">
        <h2>Create New Proposal</h2>
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" id="title" placeholder="Proposal title">
        </div>
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" rows="4" placeholder="Describe your proposal"></textarea>
        </div>
        <button id="submitProposal">Submit Proposal</button>

        <h2>Proposals</h2>
        <button id="loadProposals">Load Proposals</button>
        <div id="proposalsList"></div>
    </div>

    <script>
        // Contract address will be updated from config if available
        let CONTRACT_ADDRESS = "5C4hrfjw9DjXZTzV3MwzrrAr9P1MJhSrvWGWqi1eSuyUpnhM";
        
        // Debug logging function
        function debugLog(message, data) {
            const debugInfo = document.getElementById('debug-info');
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '10px';
            logEntry.innerHTML = `<strong>${message}</strong>: ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data || ''}`;
            debugInfo.appendChild(logEntry);
            console.log(message, data);
        }
        
        // Display contract address
        document.getElementById('contract-address').textContent = CONTRACT_ADDRESS;
        
        // Check if libraries are loaded
        window.addEventListener('load', function() {
            debugLog("Checking libraries", {
                polkadotApi: typeof polkadotApi !== 'undefined' ? 'found' : 'not found',
                polkadotUtil: typeof polkadotUtil !== 'undefined' ? 'found' : 'not found',
                polkadotExtensionDapp: typeof polkadotExtensionDapp !== 'undefined' ? 'found' : 'not found'
            });
            
            // List all global variables to help debugging
            let globals = [];
            for (let key in window) {
                if (key.toLowerCase().includes('polkadot')) {
                    globals.push(key);
                }
            }
            
            debugLog("Found Polkadot-related globals", globals);
        });
        
        // Variables
        let api;
        let contract;
        let currentAccount;
        let contractMetadata;

        // Connect to blockchain and contract
        async function connect() {
            try {
                debugLog("Starting connection process");
                document.getElementById('connection-status').textContent = "Connecting...";
                
                // List all global variables to help debugging
                let globals = [];
                for (let key in window) {
                    if (key.toLowerCase().includes('polkadot')) {
                        globals.push(key);
                    }
                }
                
                debugLog("Found Polkadot-related globals", globals);

                // Use the globals we found
                const polkadot = window.polkadotApi || window.polkadot || window.Polkadot || {};
                
                if (!polkadot.ApiPromise) {
                    debugLog("Error", "Polkadot API not found - missing library or incorrect import");
                    document.getElementById('connection-status').textContent = "Library not found";
                    return;
                }
                
                // Connect to chain
                const WsProvider = polkadot.WsProvider || polkadot.ApiPromise.WsProvider;
                if (!WsProvider) {
                    debugLog("Error", "WsProvider not found");
                    document.getElementById('connection-status').textContent = "WsProvider not found";
                    return;
                }
                
                const provider = new WsProvider('ws://localhost:9944');
                debugLog("Created WsProvider", 'ws://localhost:9944');

                try {
                    const ApiPromise = polkadot.ApiPromise;
                    api = await ApiPromise.create({ provider });
                    debugLog("API Connection successful", {
                        chainName: await api.rpc.system.chain(),
                        version: await api.rpc.system.version()
                    });
                } catch (err) {
                    debugLog("API Connection failed", err.message);
                    document.getElementById('connection-status').textContent = "Node connection failed";
                    return;
                }

                // Connect to extension
                try {
                    const extension = window.polkadotExtensionDapp || window.polkadot?.extension || {};
                    if (!extension.web3Enable) {
                        debugLog("Error", "Extension API not found");
                        document.getElementById('connection-status').textContent = "Extension API not found";
                        return;
                    }
                    
                    debugLog("Connecting to Polkadot extension");
                    const extensions = await extension.web3Enable('Governance Tracker');
                    debugLog("Extensions detected", extensions.length);

                    if (extensions.length === 0) {
                        debugLog("No extensions found", "Please install Polkadot{.js} extension");
                        document.getElementById('connection-status').textContent = "No Polkadot extension detected";
                        return;
                    }

                    const accounts = await extension.web3Accounts();
                    debugLog("Accounts found", accounts.length);

                    if (accounts.length === 0) {
                        debugLog("No accounts found", "Please create an account in Polkadot{.js} extension");
                        document.getElementById('connection-status').textContent = "No accounts in extension";
                        return;
                    }

                    currentAccount = accounts[0];
                    document.getElementById('accountAddress').textContent = currentAccount.address;
                    document.getElementById('accountInfo').style.display = 'block';
                    document.getElementById('connection-status').textContent = "Connected";
                    document.getElementById('app').style.display = 'block';
                } catch (err) {
                    debugLog("Extension connection failed", err.message);
                    document.getElementById('connection-status').textContent = "Extension connection failed";
                    return;
                }

                // Fetch contract metadata
                try {
                    debugLog("Fetching contract metadata");
                    const response = await fetch('/target/ink/governance_tracker.json');
                    contractMetadata = await response.json();
                    debugLog("Metadata loaded", { 
                        spec_name: contractMetadata.spec.name,
                        constructors: contractMetadata.spec.constructors.length
                    });

                    // Create contract instance
                    const ContractPromise = polkadot.ContractPromise || polkadot.contract?.ContractPromise;
                    if (!ContractPromise) {
                        debugLog("Error", "ContractPromise not found");
                        document.getElementById('connection-status').textContent = "Contract API not found";
                        return;
                    }
                    
                    contract = new ContractPromise(api, contractMetadata, CONTRACT_ADDRESS);
                    debugLog("Contract instance created");
                } catch (err) {
                    debugLog("Metadata loading failed", err.message);
                    document.getElementById('connection-status').textContent = "Contract metadata loading failed";
                    return;
                }
            } catch (err) {
                debugLog("Connection process failed", err.message);
                document.getElementById('connection-status').textContent = "Connection failed";
            }
        }

        // Submit a new proposal
        async function submitProposal() {
            try {
                debugLog("Preparing to submit proposal");
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                
                if (!title || !description) {
                    debugLog("Validation failed", "Title and description are required");
                    return;
                }
                
                if (!contract || !currentAccount) {
                    debugLog("Submission failed", "Contract or account not available");
                    return;
                }
                
                debugLog("Submitting proposal", { title, description });
                const extension = window.polkadotExtensionDapp || window.polkadot?.extension || {};
                const injector = await extension.web3FromSource(currentAccount.meta.source);
                
                const txResult = await contract.tx
                    .submitProposal({ value: 0, gasLimit: -1 }, title, description)
                    .signAndSend(currentAccount.address, { signer: injector.signer }, (result) => {
                        if (result.status.isInBlock) {
                            debugLog("Transaction in block", result.status.asInBlock.toHex());
                        } else if (result.status.isFinalized) {
                            debugLog("Transaction finalized", result.status.asFinalized.toHex());
                            document.getElementById('title').value = '';
                            document.getElementById('description').value = '';
                            loadProposals(); // Reload proposals after submission
                        }
                    });
                
                debugLog("Transaction submitted", txResult.toString());
            } catch (err) {
                debugLog("Proposal submission failed", err.message);
            }
        }

        // Load and display proposals
        async function loadProposals() {
            try {
                debugLog("Loading proposals");
                if (!contract) {
                    debugLog("Loading failed", "Contract not available");
                    return;
                }
                
                // First get the proposal count
                const { result: countResult } = await contract.query.getProposalCount(currentAccount.address);
                const proposalCount = countResult.toNumber();
                debugLog("Proposal count", proposalCount);
                
                const proposalsList = document.getElementById('proposalsList');
                proposalsList.innerHTML = '';
                
                // Load each proposal
                for (let i = 0; i < proposalCount; i++) {
                    const { result } = await contract.query.getProposal(currentAccount.address, i);
                    
                    if (result.isOk) {
                        const proposal = result.asOk.toJSON();
                        debugLog(`Proposal ${i}`, proposal);
                        
                        const proposalElement = document.createElement('div');
                        proposalElement.className = 'proposal';
                        proposalElement.innerHTML = `
                            <h3>${proposal.title}</h3>
                            <p>${proposal.description}</p>
                            <p><strong>Votes:</strong> ${proposal.votes}</p>
                            <p><strong>Creator:</strong> ${proposal.creator}</p>
                            <button class="vote-button" data-id="${i}">Vote</button>
                        `;
                        proposalsList.appendChild(proposalElement);
                        
                        // Add event listener to vote button
                        proposalElement.querySelector('.vote-button').addEventListener('click', () => {
                            voteOnProposal(i);
                        });
                    }
                }
                
                if (proposalCount === 0) {
                    proposalsList.innerHTML = '<p>No proposals found.</p>';
                }
            } catch (err) {
                debugLog("Loading proposals failed", err.message);
            }
        }

        // Vote on a proposal
        async function voteOnProposal(id) {
            try {
                debugLog("Preparing to vote on proposal", id);
                if (!contract || !currentAccount) {
                    debugLog("Voting failed", "Contract or account not available");
                    return;
                }
                
                // Get minimum vote amount from contract (for demonstration, using a default value)
                const minVoteAmount = 1000000000000;
                
                const extension = window.polkadotExtensionDapp || window.polkadot?.extension || {};
                const injector = await extension.web3FromSource(currentAccount.meta.source);
                
                debugLog("Voting on proposal", { id, amount: minVoteAmount });
                const txResult = await contract.tx
                    .vote({ value: minVoteAmount, gasLimit: -1 }, id)
                    .signAndSend(currentAccount.address, { signer: injector.signer }, (result) => {
                        if (result.status.isInBlock) {
                            debugLog("Vote transaction in block", result.status.asInBlock.toHex());
                        } else if (result.status.isFinalized) {
                            debugLog("Vote transaction finalized", result.status.asFinalized.toHex());
                            loadProposals(); // Reload proposals after voting
                        }
                    });
                
                debugLog("Vote transaction submitted", txResult.toString());
            } catch (err) {
                debugLog("Voting failed", err.message);
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connect);
        document.getElementById('submitProposal').addEventListener('click', submitProposal);
        document.getElementById('loadProposals').addEventListener('click', loadProposals);

        // Try to load contract address from config file
        fetch('/config/contract-address.js')
            .then(response => {
                if (!response.ok) {
                    throw new Error("Config file not found");
                }
                return response.text();
            })
            .then(text => {
                const addressMatch = text.match(/CONTRACT_ADDRESS = "([^"]+)"/);
                if (addressMatch && addressMatch[1]) {
                    const address = addressMatch[1];
                    CONTRACT_ADDRESS = address;
                    document.getElementById('contract-address').textContent = address;
                    debugLog("Loaded contract address from config", address);
                }
            })
            .catch(err => {
                debugLog("Could not load contract address config", err.message);
            });
    </script>
</body>
</html>